<!doctype html>
<html lang="en">

<body style="margin: 0px;">
  <script type="module">
    const code = `
use bevy::prelude::*;

fn main() {
    App::new()
        .insert_resource(ClearColor(Color::rgb(0.5, 0.5, 0.9)))
        .add_plugins(DefaultPlugins)
        .add_systems(Startup, setup)
        .add_systems(Update, change_clear_color)
        .run();
}

fn setup(mut commands: Commands) {
    commands.spawn(Camera2dBundle::default());
}

fn change_clear_color(input: Res<Input<KeyCode>>, mut clear_color: ResMut<ClearColor>, mut state: Local<bool>) {
    if input.just_pressed(KeyCode::Space) {
      *state = !*state;
      if *state {
        clear_color.0 = Color::PURPLE;
      } else {
        clear_color.0 = Color::RED;
      }
    }
}
  `;

    const res = await fetch("http://45.148.60.5:8080", {
      method: "POST",
      body: code,
    });

    const wasm_size = res.headers.get("wasm-content-length");
    const js_size = res.headers.get("js-content-length");

    const body = await res.blob();
    const wasm = body.slice(0, wasm_size, "application/wasm");
    const js = body.slice(wasm_size, wasm_size + js_size, "application/javascript");
    const js_text = await js.text();

    console.log(js_text);

    const AsyncFunction = async function () { }.constructor;
    const load = new AsyncFunction("wasm_blob", js_text);
    await load(wasm).catch((error) => {
      if (!error.message.startsWith("Using exceptions for control flow, don't mind me. This isn't actually an error!")) {
        throw error;
      }
    });
  </script>
</body>

</html>